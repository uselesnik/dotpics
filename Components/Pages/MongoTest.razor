@page "/mongotest"
@using DotPic.Models
@using DotPic.Services
@inject IUserService UserService

<PageTitle>MongoDB Test</PageTitle>

<h1>MongoDB Connection Test</h1>

<button class="btn btn-primary" @onclick="TestConnection">Test MongoDB Connection</button>

@if (isTesting)
{
    <div class="alert alert-info mt-3">
        <h4>Testing MongoDB connection...</h4>
        <p>Please wait while we connect to the database.</p>
    </div>
}

@if (!string.IsNullOrEmpty(testMessage))
{
    <div class="alert alert-@alertClass mt-3">
        <h4>@testMessage</h4>
        @if (!string.IsNullOrEmpty(exceptionMessage))
        {
            <div class="mt-2">
                <strong>Error Details:</strong>
                <pre class="bg-dark text-light p-2 mt-1">@exceptionMessage</pre>
            </div>
        }
    </div>
}

@if (users != null)
{
    <div class="mt-4">
        <h5>Users in Database (@users.Count):</h5>
        @if (users.Any())
        {
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Age</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in users)
                    {
                        <tr>
                            <td>@user.Name</td>
                            <td>@user.Email</td>
                            <td>@user.Age</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p>No users found in database.</p>
            <button class="btn btn-success" @onclick="AddTestUser">Add Test User</button>
        }
    </div>
}

@code {
    private bool isTesting = false;
    private string testMessage = "";
    private string alertClass = "info";
    private string? exceptionMessage;
    private List<User>? users;

    private async Task TestConnection()
    {
        isTesting = true;
        testMessage = "";
        exceptionMessage = null;
        users = null;
        StateHasChanged();

        try
        {
            // Test 1: Try to get users
            users = await UserService.GetUsersAsync();
            testMessage = "✅ MongoDB Connection Successful!";
            alertClass = "success";
            
            if (users.Count == 0)
            {
                testMessage += " Database is empty.";
            }
            else
            {
                testMessage += $" Found {users.Count} user(s).";
            }
        }
        catch (Exception ex)
        {
            testMessage = "❌ MongoDB Connection Failed!";
            alertClass = "danger";
            exceptionMessage = $"{ex.Message}\n\n{ex.StackTrace}";
            
            // Check if it's a MongoDB-specific error
            if (ex.Message.Contains("Unable to connect"))
            {
                exceptionMessage += "\n\nMake sure MongoDB is running on localhost:27017";
            }
        }
        finally
        {
            isTesting = false;
            StateHasChanged();
        }
    }

    private async Task AddTestUser()
    {
        try
        {
            var testUser = new User
            {
                Name = "Test User " + DateTime.Now.ToString("HHmmss"),
                Email = $"test{DateTime.Now:HHmmss}@example.com",
                Age = new Random().Next(18, 65)
            };

            await UserService.CreateUserAsync(testUser);
            
            // Refresh the user list
            await TestConnection();
        }
        catch (Exception ex)
        {
            testMessage = "Failed to add test user";
            exceptionMessage = ex.Message;
            alertClass = "danger";
            StateHasChanged();
        }
    }
}