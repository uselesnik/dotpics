@page "/upload"
@using DotPic.Models
@using DotPic.Services
@using DotPic.Utilities
@using Microsoft.AspNetCore.Components.Forms
@using SixLabors.ImageSharp
@using SixLabors.ImageSharp.Processing
@using System.IO
@inject IImageService ImageService
@inject NavigationManager Navigation

<PageTitle>Upload Image - DotPic</PageTitle>

<div class="container mt-4">
    <h1>üì§ Upload Image</h1>
    <p class="text-muted">Upload images to your personal cloud storage</p>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Select Image</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Choose Image File (max 5MB)</label>
                        <InputFile class="form-control" OnChange="OnInputFileChange" 
                                  accept=".jpg,.jpeg,.png,.gif,.bmp,.webp" />
                    </div>
                    
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger">@errorMessage</div>
                    }
                    
                    @if (selectedFile != null)
                    {
                        <div class="alert alert-info">
                            <p><strong>Selected File:</strong> @selectedFile.Name</p>
                            <p><strong>Size:</strong> @ImageHelper.FormatFileSize(selectedFile.Size)</p>
                            <p><strong>Type:</strong> @selectedFile.ContentType</p>
                        </div>

                        @if (imagePreviewUrl != null)
                        {
                            <div class="text-center mb-3">
                                <p><strong>Preview:</strong></p>
                                <img src="@imagePreviewUrl" class="img-thumbnail" style="max-height: 300px;" alt="Preview" />
                            </div>
                        }

                        <div class="mb-3">
                            <label for="description" class="form-label">Description (optional)</label>
                            <input type="text" class="form-control" id="description" @bind="imageDescription" 
                                   placeholder="Describe your image..." />
                        </div>

                        <div class="mb-3">
                            <label for="tags" class="form-label">Tags (optional)</label>
                            <input type="text" class="form-control" id="tags" @bind="imageTags" 
                                   placeholder="nature, vacation, etc. (comma separated)" />
                        </div>

                        <button class="btn btn-success btn-lg w-100" @onclick="UploadImage" disabled="@isUploading">
                            @if (isUploading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            üì§ Upload Image
                        </button>
                    }
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">üìä Storage Info</h5>
                </div>
                <div class="card-body">
                    <p>‚úÖ Supported formats: JPG, PNG, GIF, BMP, WebP</p>
                    <p>üìè Max file size: 5MB</p>
                    <p>üîí Your images are stored securely</p>
                    <p>üîç Add tags to make images searchable</p>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private IBrowserFile? selectedFile;
    private string? errorMessage;
    private string? imagePreviewUrl;
    private string imageDescription = "";
    private string imageTags = "";
    private bool isUploading = false;

    private async void OnInputFileChange(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        errorMessage = null;
        imagePreviewUrl = null;

        // Basic validation
        if (selectedFile.Size > 5 * 1024 * 1024) // 5MB
        {
            errorMessage = "File size must be less than 5MB";
            selectedFile = null;
            StateHasChanged();
            return;
        }

        var allowedTypes = new[] { "image/jpeg", "image/png", "image/gif", "image/bmp", "image/webp" };
        if (!allowedTypes.Contains(selectedFile.ContentType))
        {
            errorMessage = "Please select a valid image file (JPG, PNG, GIF, BMP, WebP)";
            selectedFile = null;
            StateHasChanged();
            return;
        }

        // Create preview
        try
        {
            var resizedFile = await selectedFile.RequestImageFileAsync(selectedFile.ContentType, 400, 400);
            var buffer = new byte[resizedFile.Size];
            await resizedFile.OpenReadStream().ReadAsync(buffer);
            imagePreviewUrl = $"data:{selectedFile.ContentType};base64,{Convert.ToBase64String(buffer)}";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Preview error: {ex.Message}");
            // Continue without preview
        }

        StateHasChanged();
    }

    private async Task UploadImage()
    {
        if (selectedFile == null) return;

        isUploading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            // Read the file into a byte array
            var buffer = new byte[selectedFile.Size];
            await selectedFile.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024).ReadAsync(buffer);

            // Load image with ImageSharp to get dimensions and resize if necessary
            using var image = Image.Load(buffer);
            var originalWidth = image.Width;
            var originalHeight = image.Height;

            // Resize if larger than 1024x1024, maintaining aspect ratio
            const int maxDimension = 1024;
            if (originalWidth > maxDimension || originalHeight > maxDimension)
            {
                var resizeOptions = new ResizeOptions
                {
                    Mode = ResizeMode.Max,
                    Size = new Size(maxDimension, maxDimension)
                };
                image.Mutate(x => x.Resize(resizeOptions));
            }

            // Save resized image to memory stream in original format
            using var ms = new MemoryStream();
            string fileExtension;
            string contentType;
            if (selectedFile.ContentType == "image/gif")
            {
                await image.SaveAsGifAsync(ms);
                fileExtension = ".gif";
                contentType = "image/gif";
            }
            else if (selectedFile.ContentType == "image/png" || selectedFile.ContentType == "image/webp")
            {
                await image.SaveAsPngAsync(ms);
                fileExtension = ".png";
                contentType = "image/png";
            }
            else
            {
                await image.SaveAsJpegAsync(ms);
                fileExtension = ".jpg";
                contentType = "image/jpeg";
            }
            var resizedBuffer = ms.ToArray();

            // Create image object
            var storedImage = new StoredImage
            {
                FileName = Guid.NewGuid().ToString() + fileExtension,
                OriginalFileName = selectedFile.Name,
                ContentType = contentType,
                ImageData = resizedBuffer,
                FileSize = resizedBuffer.Length,
                Description = imageDescription,
                Tags = imageTags,
                UploadDate = DateTime.UtcNow,
                Width = image.Width,
                Height = image.Height,
                UploadedBy = "User" // You can replace this with actual user info later
            };

            // Save to database
            await ImageService.UploadImageAsync(storedImage);

            // Success - redirect to gallery
            Navigation.NavigateTo("/gallery");
        }
        catch (Exception ex)
        {
            errorMessage = $"Upload failed: {ex.Message}";
        }
        finally
        {
            isUploading = false;
            StateHasChanged();
        }
    }

}