@page "/gallery"
@using DotPic.Models
@using DotPic.Services
@using DotPic.Utilities
@inject IImageService ImageService
@inject IRedisService RedisService
@inject IJSRuntime JSRuntime

<PageTitle>Image Gallery - DotPic</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Image Gallery</h1>
        <a href="/upload" class="btn btn-primary">
            Upload New Image
        </a>
    </div>

    <!-- Simple Redis Status 
    <div class="alert alert-info mb-3">
        <small>View counting: @(IsRedisAvailable ? "Active" : "Not available")</small>
        <button class="btn btn-sm btn-outline-primary ms-2" @onclick="TestRedis">Test Redis</button>
    </div>
        -->
    <!-- Search Bar -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Search by filename, description, or tags..." 
                       @bind="searchTerm" @oninput="OnSearch" />
                <button class="btn btn-outline-secondary" type="button" @onclick="ClearSearch">
                    Clear
                </button>
            </div>
        </div>
        <div class="col-md-6 text-end">
            <span class="text-muted">
                @if (images != null)
                {
                    @if (string.IsNullOrEmpty(searchTerm))
                    {
                        <text>Showing all @images.Count images</text>
                    }
                    else
                    {
                        <text>Found @images.Count matches for "@searchTerm"</text>
                    }
                }
            </span>
        </div>
    </div>

    @if (images == null)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading images...</p>
        </div>
    }
    else if (!images.Any())
    {
        <div class="text-center py-5">
            <h3>No images found</h3>
            <p class="text-muted">
                @if (string.IsNullOrEmpty(searchTerm))
                {
                    <text>You haven't uploaded any images yet.</text>
                }
                else
                {
                    <text>No images match your search.</text>
                }
            </p>
            <a href="/upload" class="btn btn-primary mt-3">Upload Your First Image</a>
        </div>
    }
    else
    {
        <div class="row">
            @foreach (var image in images)
            {
                <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                    <div class="card h-100 image-card">
                        <div class="card-img-top-container position-relative" style="height: 200px; overflow: hidden;">
                            <img src="@ImageHelper.ConvertToBase64(image.ImageData, image.ContentType)" 
                                 class="card-img-top" 
                                 alt="@image.OriginalFileName"
                                 style="height: 100%; width: 100%; object-fit: cover; cursor: pointer;"
                                 @onclick="() => ShowImageDetails(image)" />
                            <!-- View Count Badge -->
                            <div class="position-absolute top-0 end-0 m-1">
                                <span class="badge bg-dark">
                                    @GetViewCount(image.Id) views
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title text-truncate" title="@image.OriginalFileName">
                                @image.OriginalFileName
                            </h6>
                            <p class="card-text small text-muted">
                                @if (!string.IsNullOrEmpty(image.Description))
                                {
                                    <span class="d-block">@image.Description</span>
                                }
                                <span class="d-block">@ImageHelper.FormatFileSize(image.FileSize)</span>
                                <span class="d-block">Uploaded: @image.UploadDate.ToString("MMM dd, yyyy")</span>
                            </p>
                        </div>
                        <div class="card-footer bg-transparent">
                            <button class="btn btn-sm btn-outline-danger w-100" 
                                    @onclick="() => DeleteImage(image)">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Image Detail Modal -->
@if (selectedImage != null)
{
    <div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@selectedImage.OriginalFileName</h5>
                    <div class="ms-auto">
                        <span class="badge bg-primary me-2">
                            @GetViewCount(selectedImage.Id) views
                        </span>
                    </div>
                    <button type="button" class="btn-close" @onclick="CloseImageDetails"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="@ImageHelper.ConvertToBase64(selectedImage.ImageData, selectedImage.ContentType)" 
                         class="img-fluid" 
                         alt="@selectedImage.OriginalFileName"
                         style="max-height: 70vh;" />
                    
                    <div class="mt-3 text-start">
                        <p><strong>Description:</strong> @(selectedImage.Description ?? "No description")</p>
                        <p><strong>Tags:</strong> @(selectedImage.Tags ?? "No tags")</p>
                        <p><strong>Size:</strong> @ImageHelper.FormatFileSize(selectedImage.FileSize)</p>
                        <p><strong>Dimensions:</strong> @selectedImage.Width x @selectedImage.Height</p>
                        <p><strong>Uploaded:</strong> @selectedImage.UploadDate.ToString("f")</p>
                        <p><strong>Views:</strong> @GetViewCount(selectedImage.Id)</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseImageDetails">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<StoredImage>? images;
    private StoredImage? selectedImage;
    private string searchTerm = "";
    private Timer? searchTimer;
    private Dictionary<string, long> imageViews = new();
    private bool IsRedisAvailable = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadImages();
        await TestRedisConnection();
        await LoadViewCounts();
    }

    private async Task LoadImages()
    {
        try
        {
            if (string.IsNullOrEmpty(searchTerm))
            {
                images = await ImageService.GetAllImagesAsync();
            }
            else
            {
                images = await ImageService.SearchImagesAsync(searchTerm);
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading images: {ex.Message}");
        }
    }

    private async Task TestRedisConnection()
    {
        try
        {
            // Simple test - try to get a non-existent key
            await RedisService.GetViewCountAsync("test-connection");
            IsRedisAvailable = true;
            Console.WriteLine("Redis connection test: SUCCESS");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            IsRedisAvailable = false;
            Console.WriteLine($"Redis connection test: FAILED - {ex.Message}");
            StateHasChanged();
        }
    }
    
    private async Task LoadViewCounts()
    {
        if (images == null) return;
        
        Console.WriteLine("Loading view counts...");
        
        foreach (var image in images)
        {
            if (image.Id != null)
            {
                try
                {
                    var views = await RedisService.GetViewCountAsync(image.Id);
                    imageViews[image.Id] = views;
                    Console.WriteLine($"Image {image.Id}: {views} views");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error loading view count for {image.Id}: {ex.Message}");
                    imageViews[image.Id] = 0;
                }
            }
        }
        
        StateHasChanged();
    }

    private string GetViewCount(string? imageId)
    {
        if (imageId == null || !imageViews.ContainsKey(imageId))
            return "0";
        
        return imageViews[imageId].ToString();
    }

    private async Task TestRedis()
    {
        await TestRedisConnection();
        await LoadViewCounts();
    }

    private void OnSearch(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        
        searchTimer?.Dispose();
        searchTimer = new Timer(async _ => 
        {
            await InvokeAsync(LoadImages);
        }, null, 500, Timeout.Infinite);
    }

    private async Task ClearSearch()
    {
        searchTerm = "";
        await LoadImages();
    }

    private async void ShowImageDetails(StoredImage image)
    {
        // Track the view
        if (image.Id != null && IsRedisAvailable)
        {
            try
            {
                await RedisService.IncrementViewCountAsync(image.Id);
                // Update local count
                imageViews[image.Id] = await RedisService.GetViewCountAsync(image.Id);
                Console.WriteLine($"View counted for {image.Id}: {imageViews[image.Id]} views");
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error counting view: {ex.Message}");
            }
        }
        
        selectedImage = image;
        StateHasChanged();
    }

    private void CloseImageDetails()
    {
        selectedImage = null;
        StateHasChanged();
    }

    private async Task DeleteImage(StoredImage image)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete '{image.OriginalFileName}'?"))
        {
            if (image.Id != null)
            {
                await ImageService.DeleteImageAsync(image.Id);
                await LoadImages();
            }
        }
    }

    public void Dispose()
    {
        searchTimer?.Dispose();
    }
}