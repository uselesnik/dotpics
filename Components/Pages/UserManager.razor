@page "/users"
@using DotPic.Models
@using DotPic.Services
@using DotPic.Utilities
@inject IUserService UserService
@using Microsoft.AspNetCore.Components.Forms

<PageTitle>User Management</PageTitle>

<h1>User Management</h1>

<button class="btn btn-primary mb-3" @onclick="ShowAddUser">Add New User</button>

@if (users == null)
{
    <p>Loading users...</p>
}
else
{
    <div class="row">
        @foreach (var user in users)
        {
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">@user.Name</h5>
                    </div>
                    
                    <!-- Profile Image -->
                    <div class="text-center p-3">
                        @if (user.ProfileImage != null && user.ProfileImage.Length > 0)
                        {
                            <img src="@ImageHelper.ConvertToBase64(user.ProfileImage, user.ImageContentType)" 
                                 class="card-img-top rounded-circle" 
                                 alt="@user.Name"
                                 style="width: 150px; height: 150px; object-fit: cover; cursor: pointer;"
                                 @onclick="() => ShowImageUpload(user.Id)" />
                            <div>
                                <small class="text-muted">@user.FileName (@ImageHelper.FormatFileSize(user.FileSize ?? 0))</small>
                            </div>
                        }
                        else
                        {
                            <div class="bg-light rounded-circle d-flex align-items-center justify-content-center mx-auto" 
                                 style="width: 150px; height: 150px; cursor: pointer;"
                                 @onclick="() => ShowImageUpload(user.Id)">
                                <span class="text-muted">Click to upload image</span>
                            </div>
                        }
                    </div>

                    <div class="card-body">
                        <p class="card-text"><strong>Email:</strong> @user.Email</p>
                        <p class="card-text"><strong>Age:</strong> @user.Age</p>
                        <p class="card-text"><small class="text-muted">Created: @user.CreatedAt.ToString("MMM dd, yyyy")</small></p>
                        
                        <div class="btn-group w-100">
                            <button class="btn btn-sm btn-warning" @onclick="() => EditUser(user)">Edit</button>
                            <button class="btn btn-sm btn-info" @onclick="() => ShowImageUpload(user.Id)">Upload Image</button>
                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteUser(user.Id)">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

<!-- Add/Edit User Modal -->
@if (showUserDialog)
{
    <div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(currentUser.Id == null ? "Add User" : "Edit User")</h5>
                    <button type="button" class="btn-close" @onclick="CloseUserDialog"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="name" @bind="currentUser.Name" />
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" @bind="currentUser.Email" />
                    </div>
                    <div class="mb-3">
                        <label for="age" class="form-label">Age</label>
                        <input type="number" class="form-control" id="age" @bind="currentUser.Age" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseUserDialog">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveUser">Save</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Image Upload Modal -->
@if (showImageDialog)
{
    <div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Profile Image for @(selectedUser?.Name ?? "User")</h5>
                    <button type="button" class="btn-close" @onclick="CloseImageDialog"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Image (max 2MB)</label>
                        <InputFile class="form-control" OnChange="OnInputFileChange" accept=".jpg,.jpeg,.png,.gif,.bmp" />
                    </div>
                    
                    @if (!string.IsNullOrEmpty(imageError))
                    {
                        <div class="alert alert-danger">@imageError</div>
                    }
                    
                    @if (selectedFile != null)
                    {
                        <div class="alert alert-info">
                            <p><strong>Selected File:</strong> @selectedFile.Name</p>
                            <p><strong>Size:</strong> @ImageHelper.FormatFileSize(selectedFile.Size)</p>
                            <p><strong>Type:</strong> @selectedFile.ContentType</p>
                        </div>

                        @if (imagePreviewUrl != null)
                        {
                            <div class="text-center">
                                <p><strong>Preview:</strong></p>
                                <img src="@imagePreviewUrl" class="img-thumbnail" style="max-height: 200px;" alt="Preview" />
                            </div>
                        }
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseImageDialog">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="UploadImage" disabled="@(selectedFile == null)">
                        Upload Image
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirmation)
{
    <div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" @onclick="CancelDelete"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete user <strong>@userToDelete?.Name</strong>?</p>
                    <p class="text-danger">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelDelete">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<User> users = new();
    private User currentUser = new();
    private User? selectedUser;
    private User? userToDelete;
    private bool showUserDialog = false;
    private bool showImageDialog = false;
    private bool showDeleteConfirmation = false;
    private string? imageError;
    private IBrowserFile? selectedFile;
    private string? imagePreviewUrl;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        users = await UserService.GetUsersAsync();
        StateHasChanged();
    }

    private void ShowAddUser()
    {
        currentUser = new User();
        showUserDialog = true;
    }

    private void EditUser(User user)
    {
        currentUser = new User
        {
            Id = user.Id,
            Name = user.Name,
            Email = user.Email,
            Age = user.Age
        };
        showUserDialog = true;
    }

    private void ShowImageUpload(string userId)
    {
        selectedUser = users.FirstOrDefault(u => u.Id == userId);
        showImageDialog = true;
        selectedFile = null;
        imageError = null;
        imagePreviewUrl = null;
    }

    private async Task SaveUser()
    {
        if (string.IsNullOrEmpty(currentUser.Id))
        {
            await UserService.CreateUserAsync(currentUser);
        }
        else
        {
            await UserService.UpdateUserAsync(currentUser.Id, currentUser);
        }

        showUserDialog = false;
        await LoadUsers();
    }

    private void DeleteUser(string id)
    {
        userToDelete = users.FirstOrDefault(u => u.Id == id);
        showDeleteConfirmation = true;
    }

    private async Task ConfirmDelete()
    {
        if (userToDelete != null && userToDelete.Id != null)
        {
            await UserService.DeleteUserAsync(userToDelete.Id);
            showDeleteConfirmation = false;
            userToDelete = null;
            await LoadUsers();
        }
    }

    private void CancelDelete()
    {
        showDeleteConfirmation = false;
        userToDelete = null;
    }

    private async void OnInputFileChange(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        imageError = null;
        imagePreviewUrl = null;

        if (!ImageHelper.IsValidImage(selectedFile))
        {
            imageError = "Please select a valid image file (JPG, PNG, GIF, BMP) under 2MB.";
            selectedFile = null;
            StateHasChanged();
            return;
        }

        // Create preview
        try
        {
            var resizedFile = await selectedFile.RequestImageFileAsync(selectedFile.ContentType, 300, 300);
            var buffer = new byte[resizedFile.Size];
            await resizedFile.OpenReadStream().ReadAsync(buffer);
            imagePreviewUrl = $"data:{selectedFile.ContentType};base64,{Convert.ToBase64String(buffer)}";
        }
        catch
        {
            // If preview fails, just continue without preview
        }

        StateHasChanged();
    }

    private async Task UploadImage()
    {
        if (selectedFile == null || selectedUser == null || selectedUser.Id == null)
            return;

        try
        {
            // Read the file into a byte array
            var buffer = new byte[selectedFile.Size];
            await selectedFile.OpenReadStream(maxAllowedSize: 2 * 1024 * 1024).ReadAsync(buffer);

            // Update user with image data
            await UserService.UpdateUserImageAsync(
                selectedUser.Id, 
                buffer, 
                selectedFile.ContentType, 
                selectedFile.Name
            );

            // Close dialog and refresh
            CloseImageDialog();
            await LoadUsers();
            
            // Show success message
            imageError = null;
        }
        catch (Exception ex)
        {
            imageError = $"Error uploading image: {ex.Message}";
            StateHasChanged();
        }
    }

    private void CloseUserDialog()
    {
        showUserDialog = false;
    }

    private void CloseImageDialog()
    {
        showImageDialog = false;
        selectedFile = null;
        imageError = null;
        imagePreviewUrl = null;
        selectedUser = null;
    }
}